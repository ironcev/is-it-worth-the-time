param(
    [string]$Articles=(Read-Host "Articles"),
    [ValidateSet("3d", "adorners", "ad-server", "affiliate", "agile", "algorithms-and-data-structures", "amazon", "analytics", "android", "angularjs", "animation", "anti-spam", "api", "api-design", "api-testing", "app", "apparel", "app-development", "apple", "application", "applications", "applied-mathematics", "appointments", "app-virtualization", "architect", "architecture", "art", "art-blogs", "articles", "artifactory", "artificial-intelligence", "artists", "ascii-art", "asp.net", "asp.net-mvc", "aspect-oriented-programming", "aspnetmvc", "assembler", "assessments", "astronomy", "atom", "austria", "automated-testing", "avl", "azure", "baby", "backlinks", "badges", "bat", "batch", "beer", "benchmark", "big-data", "big-data-vizualization", "biking", "binary-delivery", "binary-repository", "biographies", "biology", "bitcoin", "black-screen", "blg", "blog", "blog-engine", "blogging", "blogml", "blue-light-removal", "bookmarklet", "books", "bookstore", "book-writing", "bootstrap", "broker", "budapest", "bug-tracking", "build", "bulgarian", "bus", "bycicle", "cache", "calendar", "canada", "career", "cargo", "carousel", "car-pooling", "cartoons", "casperjs", "catholicsm", "cdn", "cell-phone", "chart", "chat", "cheap-flight", "cheatsheet", "china", "chords", "chrome", "chrome-plugin", "ci", "cils", "cinema", "cisco", "classic-programmer-paintings", "cleaning", "climate", "clipart", "clipboard", "clothing", "cloud", "cmake", "cms", "code", "code-artist", "code-contracts", "code-coverage", "code-editor", "code-generation", "code-kata", "code-quality", "code-review", "code-samples", "code-snippets", "code-style", "coding-guidelines", "coffeescript", "co-founder", "colaboration-tool", "com-and-com+-programming", "comedy", "comics", "command-line", "commands", "comments", "community", "company", "comparison", "compilers", "compilers-theory", "compression", "conference", "configuration", "confluence", "console", "construction", "content", "content-curation", "contextmenu", "continous-delivery", "continuous-integration", "conversion", "converter", "cookies", "cooking", "copy-paste", "cost-of-living", "coupons", "courses", "cpp", "cqrs", "crawler", "credit-card", "crna-kronika", "croatia", "cross-platform-development", "crowdfunding", "cryptography", "csharp", "css", "cssframework", "customer-care", "customer-identity-management", "dalf", "dancing-school", "dashboard", "database", "database-programming", "data-binding", "data-generator", "data-vizualization", "datetime", "debugging", "define", "delf", "dependency-management", "deployment", "design", "design-patterns", "desired-paths", "desktop-publishing", "development-tool", "devops", "dev-service", "diagnostics", "dialog", "dictionary", "diet", "diff", "differential-geometry", "digital-fingerprint", "dissasembler", "djvu", "dns", "documentary", "documentation", "documentation-generator", "domain", "domain-specific-languages", "donations", "dos", "dotnet", "dotnet-framework", "download", "drawing", "dropdownlist", "ebook-converter", "ecommerce", "economy", "economy-and-finances", "editor", "editorial-process", "electron", "email", "email-delivery-service", "email-marketing", "email-validation", "embassy", "emulator", "encryption", "eng", "entity-framework", "entrepreneurship", "europe", "events", "evolution-and-creationism", "excell", "exceptions", "exif", "expat", "facebook", "face-recognition", "faith-and-religion", "family-tree", "fantasy", "fashion", "feedback", "fetlang", "fiction", "file-based-cms", "file-manager", "file-sharing", "file-synchronisation", "finances", "firebug", "firefox", "firequery", "fitness", "flight", "flohmarkt", "flux", "fonts", "food", "football", "foreign-language", "foreign-languages", "forum", "foursquare", "fra", "france", "freelance", "fsharp", "full-text-search", "fun", "funding", "furniture", "gadgets", "game", "game-development", "game-programming", "games", "game-server", "gay", "genealogy", "geo-ip", "geometry", "ger", "german", "gif", "gif-creator", "gis", "gist", "git", "github", "global-warming", "gmail-plugin", "good-design", "google", "google-analytics", "gradle", "grammar", "graph", "graph-database", "graphic-design", "graphics", "graphics-programming", "graz", "grids", "grocery-delivery", "guid", "guitar", "guote", "gymnastics", "hadoop", "handmade", "happiness", "hardware", "hauses", "health-and-medicine", "helpdesk", "hindi", "history", "history-and-geography", "hoax", "home", "homepage", "homosexuality", "hosting", "html", "humor", "hunter", "icon-converter", "icons", "idioms", "iis", "image-compression", "image-format", "image-optimization", "images", "include", "india", "indie", "indie-games", "influence", "infragistics", "inkscape", "in-memory", "innersource", "inspirational", "installer", "integration-testing", "interview", "investment", "iot", "ipad", "iphone", "iqmatrix", "issue-tracking", "italian", "its-i-info-letter", "java", "javascript", "javascript-loader", "jekyll", "jenkins", "jiu-jitsu", "job", "job-and-career", "job-portal", "jokes", "journalism", "jquery", "jquery-plugins", "json", "jsx", "juggling", "keyboard", "kindle", "knowledge-base", "language-learning", "language-learning-french", "languages", "language-school-french", "language-school-italian", "latex", "latin", "layout", "learning", "lgbt", "licence", "lightbox", "linguistics", "link-building", "linq", "linux", "liquid", "listening", "listview", "loadingspeed", "localization", "logging", "logos", "lorem-ipsum", "love-and-sexuality", "loyalty-cards", "mac", "machine-learning", "machine-translation", "macosx", "magazin", "manliness", "map", "mapping", "marge", "markdown", "marketing", "martial-art", "massage", "material-design-css", "math", "mathematics", "medium", "meme", "menu", "messaging", "messaging-server", "mfc", "microsoft", "migrations", "military", "mind-map", "minifier", "mlm", "mobile-development", "mobile-devices", "mocking", "model-driven-development", "modern-ui", "mongodb", "monitoring", "montreal", "mormonism", "movie-creation", "movies", "movie-scripts", "msbuild", "msdeploy", "msdn", "msdos", "multi-language", "multilingual", "multithreading", "music", "music-learning", "mvc", "mvvm", "name", "name-generator", "natural-language-generation", "networking", "network-traffic", "newman-n2", "newsletter", "newspaper", "newsql", "new-york", "nhibernate", "niche", "node.js", "nodejs", "nosql", "notes", "note-taking", "notifications", "notification-service", "npm", "nuget", "null-is-evil", "nunit", "office", "onenote", "online-bookstore", "online-compiler", "online-courses", "online-editor", "online-shop", "oop", "opensource", "open-source", "operating-systems", "optimization", "orm", "osijek", "outlook-plugin", "outsourcing", "paas", "pagespeed", "paper", "paper-generator", "parenting", "paris", "parser", "parser-generator", "password", "password-recovery", "patent", "pdf", "pencil", "performance", "persistency", "person", "personal-finances", "petition", "phantomjs", "phd", "photography", "photos", "php", "phrases", "physics", "piracy", "piwik", "plugin", "png", "poco", "podcast", "poetry", "politics", "popular-science", "popup", "powershell", "pr", "pragma", "presentation", "prettify", "pretty-print", "printing", "privacy", "problem-solving", "processing", "processingjs", "productivity", "profiler", "programmer", "programming", "programming-community", "programming-language", "programming-languages", "project-managment-tool", "prototyping", "psychology", "public-speaking", "publishing", "push-notifications", "python", "q&a", "qti", "quality-newsletter", "query-language", "quote", "quotes", "r", "radio", "random", "ravendb", "react", "reactive-programming", "reactiveui", "reading-content", "reference", "region", "regular-expressions", "relax", "religion", "remember", "rendering", "reporting", "resharper", "responsive", "responsive-grids", "responsive-images", "rest", "restaurant", "reviews", "rmarkdown", "romania", "romanian", "romantic", "rome", "roslyn", "rstudio", "ruby", "runner", "running", "rust", "rx", "scala", "science", "screen-capture", "screencast", "screen-recording", "scripting", "scripts", "search", "search-replace", "security", "seo", "seo-crawler", "serbia", "serializer", "sf", "sharing", "shop", "shortcuts", "signalr", "sitemap", "sketching", "slack", "slides", "snippets", "soa", "social-network", "social-networks", "social-share-button", "sociology", "software-architecture", "software-components", "software-development", "software-modeling", "software-testing", "source", "source-code-editor", "source-repository", "spam", "speach-recognition", "speach-to-text", "speaking", "spell-checker", "sport", "spy", "sql", "sqlce", "sql-light", "ssl", "stand-up-comedy", "start-up", "starwars", "statical-code-analysis", "static-analysis", "static-site-generator", "statistics", "stickers", "streaming", "stress-testing", "styles", "survey", "sustainability", "svg", "synonyms", "syntax-highlighting", "talk", "tango", "taxi", "tea", "teamcity", "tell-it", "template-engine", "templates", "terminology", "testing", "tests", "text-tools", "text-to-speach", "thailand", "themes", "theology", "thesaurus", "threading", "threejs", "time", "time-tracking", "tool", "tooltip", "torrent", "traffic", "translation", "translator", "traveling", "treeview", "tutorials", "twitter", "typescript", "typing", "typography", "ui-controls", "uml", "unicode", "unit-testing", "upload", "urban-legend", "url-shortener", "usa", "usability", "user-managment", "utility", "ux", "v8", "validation", "venture-capital", "version-control", "video", "video-conference", "video-creation", "video-hosting", "virtualbox", "virtual-reality", "visual-comparison", "visual-studio-extension", "visual-studio-plugin", "vlasi", "vulnerability", "wcf", "weather", "web", "web-analytics", "web-api", "web-components", "web-design", "web-development", "web-performance", "web-programming", "web-server", "website-builder", "websiteoptimization", "web-site-selling", "web-sockets", "web-testing", "web-traffic", "wf", "what-is-new-in-csharp-7.0-and-7.1", "what's-new-in-csharp-6.0", "why-your-company-should-contribute-to-open-source", "wifi", "wiki-engine", "win32", "windbg", "windows", "windows-forms", "windows-services", "wirtschaftsnachrichten-sued", "wood", "words", "workflow", "worldmap", "wpf", "writing", "writing-courses", "xamarin", "xml", "yaml", "zip")]    
    [string[]]$Tags,
    [string[]]$CustomTags,
    [switch]$CreateStufflyFiles=$false,
    [switch]$DoNotOpenNpp=$false,
    [string]$StufflyDirectory="c:\Users\Igor\Dropbox\stuffly\"
)

. (Join-Path $PSScriptRoot "Common.ps1")

$currentDirectory = New-Object System.IO.DirectoryInfo $(Get-Location)
$articlesStufflyFile = (Join-Path $StufflyDirectory "Articles.txt")
$articlesBackupFile = (Join-Path $StufflyDirectory "Articles.backup.txt")
$date = [System.DateTime]::Today.ToString("yyyy.MM.dd")

AssertThatFileExists $articlesStufflyFile "Check if the StufflyDirectory is properly set."

# Create backup file.
[System.IO.File]::Copy($articlesStufflyFile, $articlesBackupFile, $true)

$articleFiles = $currentDirectory.GetFiles($Articles)

AssertThat ($articleFiles.Length -gt 0) "There are no articles that satisfy the given filter '$($Articles)'."

# Append articles to the articles stuffly file.
$sb = New-Object System.Text.StringBuilder
foreach ($file in $articleFiles) {
    $fileName = [System.IO.Path]::GetFileNameWithoutExtension($file.Name)
    $sb.Append("$($date) $($fileName)") | Out-Null
    foreach($tag in $Tags) {
        $sb.Append(" #$($tag)") | Out-Null
    }
    foreach($customTag in $CustomTags) {
        $sb.Append(" #$($customTag)") | Out-Null
    }
    $sb.AppendLine() | Out-Null
}
[System.IO.File]::AppendAllText($articlesStufflyFile, $sb.ToString())
Confirmation "The following articles have been added:"
Confirmation $sb.ToString()

# Create stuffly file for the articles.
if ($CreateStufflyFiles) {
    $initialArticleStufflyFileContent = "$($date) `n$($date) `n$($date) `n$($date) `n$($date) `n$($date) `n"
    foreach ($file in $articleFiles) {
        $stufflyFileName = Join-Path $StufflyDirectory "Articles\$([System.IO.Path]::GetFileNameWithoutExtension($file.Name) + ".txt")"
        [System.IO.File]::AppendAllText($stufflyFileName, $initialArticleStufflyFileContent)
        if (!$DoNotOpenNpp) {
            Invoke-Expression -Command ".\npp.bat ""$($stufflyFileName)"""
        }
    }
    Confirmation "Stuffly files have been created for all the articles."
}